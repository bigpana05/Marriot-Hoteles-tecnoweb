<section class="admin-coupons p-4">
  <div class="page-header mb-4">
    <h1>Gestión de Cupones</h1>
    <p class="text-muted">Crea y administra códigos de descuento para reservas.</p>
  </div>

  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle-fill me-2"></i>{{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = null"></button>
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = null"></button>
  </div>

  <div class="row">
    <div class="col-lg-5 mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">{{ isEditing ? 'Editar Cupón' : 'Nuevo Cupón' }}</h5>
        </div>
        <div class="card-body">
          <form #f="ngForm" (ngSubmit)="save(f)">
            
            <div class="mb-3">
              <label class="form-label">Código *</label>
              <input type="text" class="form-control text-uppercase" name="code" 
                     [(ngModel)]="formModel.code" 
                     required 
                     minlength="3"
                     maxlength="20"
                     pattern="[a-zA-Z0-9]+"
                     placeholder="Ej: VERANO2025"
                     [disabled]="isEditing">
              <div class="form-text">Solo letras y números, sin espacios.</div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Tipo Desc. *</label>
                <select class="form-select" name="discountType" [(ngModel)]="formModel.discountType" required>
                  <option value="PERCENTAGE">Porcentaje (%)</option>
                  <option value="FIXED">Monto Fijo ($)</option>
                </select>
              </div>
              
              <div class="col-md-6 mb-3">
                <label class="form-label">Valor *</label>
                <input type="number" class="form-control" name="discountValue" 
                       [(ngModel)]="formModel.discountValue" 
                       required 
                       min="1"
                       [max]="formModel.discountType === 'PERCENTAGE' ? 100 : 10000">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Válido hasta *</label>
              <input type="date" class="form-control" name="validUntil" 
                     [(ngModel)]="formModel.validUntil" 
                     required
                     [min]="minDate">
            </div>

            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" name="description" rows="2" 
                        [(ngModel)]="formModel.description" placeholder="Descripción interna..."></textarea>
            </div>

            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="isPublic" 
                     name="isPublic" [(ngModel)]="formModel.isPublic">
              <label class="form-check-label" for="isPublic">
                Es Público (Mostrar en Home)
              </label>
            </div>

            <div class="form-check form-switch mb-4">
              <input class="form-check-input" type="checkbox" id="isActive" 
                     name="isActive" [(ngModel)]="formModel.isActive">
              <label class="form-check-label" for="isActive">
                Cupón Activo
              </label>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" [disabled]="f.invalid">
                {{ isEditing ? 'Actualizar Cupón' : 'Crear Cupón' }}
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetForm(f)" *ngIf="isEditing">
                Cancelar Edición
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 text-primary">Lista de Cupones ({{ coupons.length }})</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Código</th>
                  <th>Descuento</th>
                  <th>Estado</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of coupons">
                  <td class="fw-bold text-uppercase">{{ c.code }}</td>
                  <td>
                    <span class="badge bg-info text-dark">
                      {{ c.discountType === 'PERCENTAGE' ? c.discountValue + '%' : '$' + c.discountValue }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex flex-column gap-1">
                      <span class="badge" [ngClass]="c.isActive ? 'bg-success' : 'bg-secondary'">
                        {{ c.isActive ? 'Activo' : 'Inactivo' }}
                      </span>
                      <span class="badge border text-dark" [ngClass]="c.isPublic ? 'border-primary' : 'border-secondary'">
                        {{ c.isPublic ? 'Público' : 'Privado' }}
                      </span>
                    </div>
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-2" (click)="edit(c)" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="delete(c.id!)" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="coupons.length === 0">
                  <td colspan="4" class="text-center py-5 text-muted">
                    <i class="bi bi-ticket-perforated display-4 d-block mb-3"></i>
                    No hay cupones registrados.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>